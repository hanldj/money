<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è±¬æ’²æ»¿ - å®Œæ•´ç´€éŒ„ç‰ˆ</title>
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --bg: #f7f9fc;
            --card: #ffffff;
            --text: #2d3436;
            --gray: #95a5a6;
            --log-bg: #f1f3f5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ä»‹é¢å€å¡Šæ¨£å¼ */
        .header, .card, .log-section {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            box-sizing: border-box;
            padding: 15px;
        }

        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ex-rate-input { width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }

        .currency-toggle { background: #eee; padding: 4px; border-radius: 10px; display: flex; }
        .currency-toggle label { padding: 6px 12px; cursor: pointer; border-radius: 8px; font-size: 0.85rem; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + label { background: var(--primary); color: white; }

        .tool-bar { display: flex; gap: 8px; margin-top: 10px; }
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-small { flex: 1; padding: 8px; font-size: 0.8rem; color: white; }
        .btn-undo { background: var(--gray); }
        .btn-admin { background: #636e72; }

        /* å¡ç‰‡å…§å®¹ */
        .card { border-left: 10px solid var(--primary); padding: 20px; }
        .name-input { font-size: 1.2rem; font-weight: 800; border: none; background: transparent; width: 100%; outline: none; }
        .balance-display { font-size: 1.8rem; font-family: monospace; font-weight: bold; color: var(--primary); margin: 8px 0; }
        .deposit-zone { display: flex; gap: 10px; }
        .deposit-input { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; outline: none; }
        .btn-deposit { background: var(--secondary); color: white; padding: 0 15px; }

        /* ç´€éŒ„å€æ¨£å¼ */
        .log-section { background: var(--card); }
        .log-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; color: var(--gray); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .log-item { font-size: 0.75rem; border-bottom: 1px solid #f8f8f8; padding: 8px 0; color: #636e72; line-height: 1.4; }
        .log-time { color: #b2bec3; font-family: monospace; }
        .log-change { display: block; margin-top: 2px; }
        .log-arrow { color: var(--secondary); font-weight: bold; }

        /* å¾Œå°é®ç½© */
        #backend-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white; z-index: 1000; padding: 25px; box-sizing: border-box; overflow-y: auto;
        }
        .backend-item { background: #333; padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .backend-item input { width: 100%; background: #111; color: #00ff00; border: 1px solid #444; padding: 8px; border-radius: 5px; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="header">
    <div class="settings-row">
        <span>åŒ¯ç‡ 1 USD = <input type="number" id="exRate" class="ex-rate-input" value="31.42" onchange="saveData()"> TWD</span>
    </div>
    <div class="settings-row">
        <span>å¹£åˆ¥:</span>
        <div class="currency-toggle">
            <input type="radio" name="curr" id="currUSD" value="USD" onchange="setCurrency('USD')"><label for="currUSD">USD</label>
            <input type="radio" name="curr" id="currTWD" value="TWD" onchange="setCurrency('TWD')"><label for="currTWD">TWD</label>
        </div>
    </div>
    <div class="tool-bar">
        <button class="btn-small btn-undo" onclick="undo()">â†© å¾©åŸ</button>
        <button class="btn-small btn-undo" onclick="redo()">â†ª é‡åš</button>
        <button class="btn-small btn-admin" onclick="openBackend()">âš™ï¸ å¾Œå°ç®¡ç†</button>
    </div>
</div>

<div id="kids-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>

<div class="log-section">
    <div class="log-title">ğŸ•’ æœ€è¿‘ 10 ç­†ä¿®æ”¹ç´€éŒ„</div>
    <div id="log-list">
        <div style="text-align: center; color: #ccc; padding: 10px;">å°šç„¡ç´€éŒ„</div>
    </div>
</div>

<div id="backend-overlay">
    <h2>ğŸ›  å¾Œå°ç®¡ç†</h2>
    <div id="backend-list"></div>
    <button onclick="saveBackend()" style="width:100%; padding:15px; background:var(--primary); color:white; border-radius:10px; font-size:1rem;">å„²å­˜</button>
    <button onclick="closeBackend()" style="width:100%; margin-top:10px; padding:10px; background:none; border:1px solid #555; color:#999;">å–æ¶ˆ</button>
</div>

<script>
    const INTEREST_RATE_PER_SEC = 0.000000001607;
    let state = {
        preferredCurrency: "USD",
        exRate: 31.42,
        kids: [
            { id: 0, name: "Lionel", baseBalance: 100, lastTimestamp: Date.now() },
            { id: 1, name: "Yosie", baseBalance: 89.99, lastTimestamp: Date.now() },
            { id: 2, name: "Yvonne", baseBalance: 89.99, lastTimestamp: Date.now() }
        ],
        logs: []
    };

    let historyStack = [], redoStack = [];

    function init() {
        const saved = localStorage.getItem('piggy_bank_v3');
        if (saved) state = JSON.parse(saved);
        document.getElementById('exRate').value = state.exRate;
        if (state.preferredCurrency === "TWD") document.getElementById('currTWD').checked = true;
        else document.getElementById('currUSD').checked = true;
        renderCards();
        renderLogs();
        tick();
    }

    function saveData() {
        state.exRate = parseFloat(document.getElementById('exRate').value) || 31.42;
        localStorage.setItem('piggy_bank_v3', JSON.stringify(state));
    }

    function addLog(name, oldVal, newVal) {
        const time = new Date().toLocaleString('zh-TW', { hour12: false });
        state.logs.unshift({ time, name, oldVal, newVal });
        if (state.logs.length > 10) state.logs.pop();
        renderLogs();
    }

    function renderLogs() {
        const logList = document.getElementById('log-list');
        if (state.logs.length === 0) return;

        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        const sym = isTWD ? "NT$" : "$";
        const dec = isTWD ? 5 : 6;

        logList.innerHTML = state.logs.map(log => {
            const displayOld = (isTWD ? log.oldVal * rate : log.oldVal).toFixed(dec);
            const displayNew = (isTWD ? log.newVal * rate : log.newVal).toFixed(dec);
            return `
                <div class="log-item">
                    <span class="log-time">[${log.time}]</span> <b>${log.name}</b><br>
                    <span class="log-change">${sym}${displayOld} <span class="log-arrow">âœ</span> ${sym}${displayNew}</span>
                </div>
            `;
        }).join('');
    }

    function calculateCurrentBalance(kid) {
        const secondsElapsed = (Date.now() - kid.lastTimestamp) / 1000;
        return kid.baseBalance * Math.pow(1 + INTEREST_RATE_PER_SEC, secondsElapsed);
    }

    function setCurrency(val) { state.preferredCurrency = val; saveData(); renderLogs(); }

    function deposit(id) {
        const input = document.getElementById(`input-${id}`);
        const amount = parseFloat(input.value);
        if (isNaN(amount) || amount <= 0) return;

        pushHistory();
        const kid = state.kids.find(k => k.id === id);
        const oldUsd = calculateCurrentBalance(kid);
        const usdToAdd = (state.preferredCurrency === "TWD") ? amount / state.exRate : amount;

        kid.baseBalance = oldUsd + usdToAdd;
        kid.lastTimestamp = Date.now();

        addLog(kid.name, oldUsd, kid.baseBalance);
        input.value = '';
        saveData();
    }

    function renderCards() {
        document.getElementById('kids-container').innerHTML = state.kids.map(kid => `
            <div class="card">
                <input type="text" class="name-input" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                <div class="balance-display" id="balance-${kid.id}">0.00</div>
                <div class="deposit-zone">
                    <input type="number" class="deposit-input" id="input-${kid.id}" placeholder="é‡‘é¡" inputmode="decimal">
                    <button class="btn-deposit" onclick="deposit(${kid.id})">å­˜å…¥</button>
                </div>
            </div>
        `).join('');
    }

    function updateName(id, name) { state.kids.find(k => k.id === id).name = name; saveData(); renderLogs(); }

    function openBackend() {
        document.getElementById('backend-list').innerHTML = state.kids.map(kid => `
            <div class="backend-item">
                <label>${kid.name} (USD)</label>
                <input type="number" id="back-${kid.id}" step="0.000001" value="${calculateCurrentBalance(kid).toFixed(6)}">
            </div>
        `).join('');
        document.getElementById('backend-overlay').style.display = 'block';
    }

    function saveBackend() {
        pushHistory();
        state.kids.forEach(kid => {
            const oldUsd = calculateCurrentBalance(kid);
            const newVal = parseFloat(document.getElementById(`back-${kid.id}`).value);
            if (!isNaN(newVal) && Math.abs(oldUsd - newVal) > 0.000001) {
                kid.baseBalance = newVal;
                kid.lastTimestamp = Date.now();
                addLog(kid.name, oldUsd, newVal);
            }
        });
        saveData();
        closeBackend();
    }

    function closeBackend() { document.getElementById('backend-overlay').style.display = 'none'; }

    function pushHistory() { historyStack.push(JSON.stringify(state)); redoStack = []; if (historyStack.length > 30) historyStack.shift(); }

    function undo() {
        if (historyStack.length > 0) {
            redoStack.push(JSON.stringify(state));
            state = JSON.parse(historyStack.pop());
            saveData(); renderCards(); renderLogs();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            historyStack.push(JSON.stringify(state));
            state = JSON.parse(redoStack.pop());
            saveData(); renderCards(); renderLogs();
        }
    }

    function tick() {
        const isTWD = state.preferredCurrency === "TWD";
        const dec = isTWD ? 5 : 6;
        state.kids.forEach(kid => {
            let bal = calculateCurrentBalance(kid);
            if (isTWD) bal *= state.exRate;
            document.getElementById(`balance-${kid.id}`).innerText = `${isTWD ? 'NT$' : '$'} ${bal.toFixed(dec)}`;
        });
        requestAnimationFrame(tick);
    }

    init();
</script>

</body>
</html>
