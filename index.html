<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è±¬æ’²æ»¿ - é«˜ç²¾åº¦ç´€éŒ„ç‰ˆ</title>
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --bg: #f7f9fc; --card: #ffffff; --text: #2d3436; --gray: #95a5a6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }

        /* å€å¡Šé€šç”¨æ¨£å¼ */
        .header, .card, .log-section { width: 100%; max-width: 500px; background: var(--card); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; padding: 15px; box-sizing: border-box; }

        /* é ‚éƒ¨è¨­å®š */
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ex-rate-input { width: 75px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 0.9rem; }
        .currency-toggle { background: #eee; padding: 4px; border-radius: 10px; display: flex; }
        .currency-toggle label { padding: 6px 12px; cursor: pointer; border-radius: 8px; font-size: 0.85rem; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + label { background: var(--primary); color: white; }

        /* å·¥å…·åˆ— */
        .tool-bar { display: flex; gap: 8px; margin-top: 10px; }
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; color: white; }
        .btn-small { flex: 1; padding: 10px; font-size: 0.8rem; }
        .btn-undo { background: var(--gray); }
        .btn-admin { background: #636e72; }

        /* å…’ç«¥å¡ç‰‡ */
        .card { border-left: 10px solid var(--primary); }
        .name-input { font-size: 1.2rem; font-weight: 800; border: none; background: transparent; width: 100%; outline: none; }
        .balance-display { font-size: 1.45rem; font-family: 'Courier New', Courier, monospace; font-weight: bold; color: var(--primary); margin: 10px 0; letter-spacing: -0.5px; }
        .deposit-zone { display: flex; gap: 8px; }
        .deposit-input { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; outline: none; width: 35%; font-size: 1rem; }
        .btn-deposit { padding: 0 15px; height: 45px; font-size: 0.9rem; flex-shrink: 0; }

        /* ç´€éŒ„å€ */
        .log-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; color: var(--gray); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .log-item { font-size: 0.75rem; border-bottom: 1px solid #f1f3f5; padding: 10px 0; line-height: 1.6; }
        .log-time { color: #b2bec3; font-family: monospace; }
        .tag { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.7rem; margin-right: 4px; display: inline-block; }
        .tag-deposit { background: var(--secondary); }
        .tag-expense { background: var(--primary); }
        .tag-admin { background: #636e72; }
        .log-amount { color: #636e72; display: block; margin-top: 3px; font-family: monospace; word-break: break-all; }

        /* å¾Œå°é®ç½© */
        #backend-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 1000; padding: 25px; box-sizing: border-box; overflow-y: auto; color: white; }
        .backend-item { background: #333; padding: 12px; border-radius: 12px; margin-bottom: 12px; }
        .backend-item input { width: 100%; background: #111; color: #00ff00; border: 1px solid #444; padding: 10px; font-size: 1.1rem; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="header">
    <div class="settings-row">
        <span>åŒ¯ç‡ 1 USD = <input type="number" id="exRate" class="ex-rate-input" value="31.42" step="0.01" onchange="saveData()"> TWD</span>
    </div>
    <div class="settings-row">
        <span>é¡¯ç¤ºå¹£åˆ¥:</span>
        <div class="currency-toggle">
            <input type="radio" name="curr" id="currUSD" value="USD" onchange="setCurrency('USD')"><label for="currUSD">USD</label>
            <input type="radio" name="curr" id="currTWD" value="TWD" onchange="setCurrency('TWD')"><label for="currTWD">TWD</label>
        </div>
    </div>
    <div class="tool-bar">
        <button class="btn-small btn-undo" onclick="undo()">â†© å¾©åŸ</button>
        <button class="btn-small btn-undo" onclick="redo()">â†ª é‡åš</button>
        <button class="btn-small btn-admin" onclick="openBackend()">âš™ï¸ å¾Œå°ç®¡ç†</button>
    </div>
</div>

<div id="kids-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>

<div class="log-section">
    <div class="log-title">ğŸ•’ æœ€è¿‘ 10 ç­†è®Šå‹•ç´€éŒ„</div>
    <div id="log-list">
        <div style="text-align: center; color: #ccc; padding: 10px;">å°šç„¡ç´€éŒ„</div>
    </div>
</div>

<div id="backend-overlay">
    <h2>ğŸ›  å¾Œå°æ•¸å€¼ç›´æ¥ä¿®æ”¹</h2>
    <p style="color: #ff7675; font-size: 0.8rem; margin-bottom: 20px;">ä¿®æ”¹å¾Œå°‡ä»¥æ–°æ•¸å€¼ä½œç‚ºåŸºæº–é»é‡æ–°è¨ˆç®—è¤‡åˆ©ã€‚</p>
    <div id="backend-list"></div>
    <button onclick="saveBackend()" style="width:100%; padding:15px; background:var(--primary); border-radius:10px; font-size:1.1rem; margin-top:10px;">ç¢ºèªå„²å­˜</button>
    <button onclick="closeBackend()" style="width:100%; margin-top:10px; padding:10px; background:none; border:1px solid #555; color: #999;">å–æ¶ˆè¿”å›</button>
</div>

<script>
    const INTEREST_RATE_PER_SEC = 0.000000001607;
    let state = { preferredCurrency: "USD", exRate: 31.42, kids: [
        { id: 0, name: "Lionel", baseBalance: 100, lastTimestamp: Date.now() },
        { id: 1, name: "Yosie", baseBalance: 89.99, lastTimestamp: Date.now() },
        { id: 2, name: "Yvonne", baseBalance: 89.99, lastTimestamp: Date.now() }
    ], logs: [] };

    let historyStack = [], redoStack = [];

    function init() {
        const saved = localStorage.getItem('piggy_bank_v12p');
        if (saved) state = JSON.parse(saved);
        document.getElementById('exRate').value = state.exRate || 31.42;
        if (state.preferredCurrency === "TWD") document.getElementById('currTWD').checked = true;
        else document.getElementById('currUSD').checked = true;
        renderCards(); renderLogs(); tick();
    }

    function saveData() {
        state.exRate = parseFloat(document.getElementById('exRate').value) || 31.42;
        localStorage.setItem('piggy_bank_v12p', JSON.stringify(state));
    }

    function addLog(action, name, oldVal, newVal) {
        const time = new Date().toLocaleString('zh-TW', { hour12: false });
        state.logs.unshift({ time, action, name, oldVal, newVal });
        if (state.logs.length > 10) state.logs.pop();
        renderLogs();
    }

    function format12(num) {
        // ç¢ºä¿ç¸½ä½æ•¸ç‚º 12 ä½ï¼ˆå«æ•´æ•¸èˆ‡å°æ•¸ï¼‰
        return Number(num).toPrecision(12);
    }

    function renderLogs() {
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        const sym = isTWD ? "NT$" : "$";

        const listEl = document.getElementById('log-list');
        if (state.logs.length === 0) return;

        listEl.innerHTML = state.logs.map(log => {
            let tagClass = "tag-admin";
            if(log.action === "å­˜å…¥") tagClass = "tag-deposit";
            if(log.action === "æ”¯å‡º") tagClass = "tag-expense";

            const displayOld = format12(log.oldVal * (isTWD ? rate : 1));
            const displayNew = format12(log.newVal * (isTWD ? rate : 1));

            return `
                <div class="log-item">
                    <span class="log-time">[${log.time.split(' ')[1]}]</span>
                    <span class="tag ${tagClass}">${log.action}</span> <b>${log.name}</b>
                    <span class="log-amount">${sym}${displayOld} âœ ${sym}${displayNew}</span>
                </div>
            `;
        }).join('');
    }

    function calculateCurrentBalance(kid) {
        return kid.baseBalance * Math.pow(1 + INTEREST_RATE_PER_SEC, (Date.now() - kid.lastTimestamp) / 1000);
    }

    function setCurrency(val) { state.preferredCurrency = val; saveData(); renderLogs(); }

    function deposit(id, isExpense) {
        const input = document.getElementById(`input-${id}`);
        let amount = parseFloat(input.value);
        if (isNaN(amount) || amount === 0) return;

        const actionType = isExpense ? "æ”¯å‡º" : "å­˜å…¥";
        if (isExpense) amount = -Math.abs(amount);

        pushHistory();
        const kid = state.kids.find(k => k.id === id);
        const oldUsd = calculateCurrentBalance(kid);
        const usdToAdd = (state.preferredCurrency === "TWD") ? amount / state.exRate : amount;

        kid.baseBalance = oldUsd + usdToAdd;
        kid.lastTimestamp = Date.now();

        addLog(actionType, kid.name, oldUsd, kid.baseBalance);
        input.value = ''; saveData();
    }

    function renderCards() {
        document.getElementById('kids-container').innerHTML = state.kids.map(kid => `
            <div class="card">
                <input type="text" class="name-input" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                <div class="balance-display" id="balance-${kid.id}">0.00</div>
                <div class="deposit-zone">
                    <input type="number" class="deposit-input" id="input-${kid.id}" placeholder="é‡‘é¡" inputmode="decimal">
                    <button class="btn-deposit" style="background:var(--secondary);" onclick="deposit(${kid.id}, false)">å­˜å…¥</button>
                    <button class="btn-deposit" style="background:var(--primary);" onclick="deposit(${kid.id}, true)">æ”¯å‡º</button>
                </div>
            </div>
        `).join('');
    }

    function updateName(id, name) { state.kids.find(k => k.id === id).name = name; saveData(); renderLogs(); }

    function openBackend() {
        document.getElementById('backend-list').innerHTML = state.kids.map(kid => `
            <div class="backend-item">
                <label>${kid.name} (USD åŸºæº–é¡)</label>
                <input type="number" id="back-${kid.id}" step="0.000001" value="${calculateCurrentBalance(kid).toFixed(8)}">
            </div>
        `).join('');
        document.getElementById('backend-overlay').style.display = 'block';
    }

    function saveBackend() {
        pushHistory();
        state.kids.forEach(kid => {
            const oldUsd = calculateCurrentBalance(kid);
            const newVal = parseFloat(document.getElementById(`back-${kid.id}`).value);
            if (!isNaN(newVal) && Math.abs(oldUsd - newVal) > 0.0000001) {
                kid.baseBalance = newVal;
                kid.lastTimestamp = Date.now();
                addLog("å¾Œå°", kid.name, oldUsd, newVal);
            }
        });
        saveData(); closeBackend();
    }

    function closeBackend() { document.getElementById('backend-overlay').style.display = 'none'; }
    function pushHistory() { historyStack.push(JSON.stringify(state)); redoStack = []; if (historyStack.length > 30) historyStack.shift(); }

    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(state)); state = JSON.parse(historyStack.pop()); saveData(); renderCards(); renderLogs(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(state)); state = JSON.parse(redoStack.pop()); saveData(); renderCards(); renderLogs(); } }

    function tick() {
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        state.kids.forEach(kid => {
            let bal = calculateCurrentBalance(kid) * (isTWD ? rate : 1);
            const el = document.getElementById(`balance-${kid.id}`);
            if (el) {
                // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ toPrecision(12) é¡¯ç¤º 12 ä½æœ‰æ•ˆæ•¸å­—
                el.innerText = `${isTWD ? 'NT$' : '$'} ${format12(bal)}`;
            }
        });
        requestAnimationFrame(tick);
    }
    init();
</script>
</body>
</html>
