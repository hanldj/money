<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è±¬æ’²æ»¿ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&display=swap');
        :root { --bg-dark: #0d1117; --card-dark: #161b22; --border-dark: #30363d; }
        body { background-color: var(--bg-dark); color: #c9d1d9; font-family: -apple-system, sans-serif; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background-color: var(--card-dark); border: 1px solid var(--border-dark); border-radius: 12px; }
        .btn-green { background-color: #238636; color: white; }
        .btn-red { background-color: #da3633; color: white; }
        input { background: #0d1117 !important; border: 1px solid var(--border-dark) !important; color: white !important; outline: none; }
        input:focus { border-color: #58a6ff !important; }
        /* éš±è—æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-bold text-white flex items-center">
                <span class="mr-2">ğŸ’°</span> å°è±¬æ’²æ»¿
            </h1>
            <p class="text-[10px] text-gray-500 mono uppercase tracking-widest">Compounding Sec-Rate: 1.607e-9</p>
        </div>
        <div class="flex space-x-2">
            <button onclick="handleUndo()" class="bg-gray-800 p-2 rounded border border-gray-700 active:bg-gray-700">â†©ï¸</button>
            <button onclick="toggleCurrency()" id="currBtn" class="bg-gray-800 px-3 py-1 rounded text-sm font-bold text-yellow-500 border border-gray-700">TWD</button>
        </div>
    </div>

    <div class="card p-3 mb-6 flex items-center justify-between text-sm">
        <div class="flex items-center">
            <span class="text-gray-400 mr-2">1 USD =</span>
            <input type="number" id="exRateIn" step="0.1" class="w-16 px-2 py-1 rounded text-center mono" onchange="updateExRate(this.value)">
            <span class="ml-2 text-gray-400">TWD</span>
        </div>
        <button onclick="toggleAdmin()" class="text-gray-500 p-1">âš™ï¸</button>
    </div>

    <div id="membersContainer" class="space-y-4"></div>

    <div class="card mt-8 p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-bold text-gray-400">è³‡ç”¢èµ°å‹¢ (USD)</h3>
            <select id="chartSelect" onchange="updateChart()" class="bg-transparent text-blue-400 text-sm outline-none font-bold"></select>
        </div>
        <div class="h-60 w-full">
            <canvas id="assetChart"></canvas>
        </div>
    </div>

    <div class="mt-8">
        <h3 class="text-xs font-bold mb-3 text-gray-500 uppercase">Recent Transactions</h3>
        <div id="logContainer" class="space-y-2"></div>
    </div>

    <div id="adminModal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div class="card w-full max-w-sm p-6 border-red-900/50">
            <h2 class="text-lg font-bold mb-4 text-red-500">ç³»çµ±æ ¡æ­£é¢æ¿</h2>
            <div id="adminFields" class="space-y-4"></div>
            <div class="mt-8 pt-4 border-t border-gray-800 flex flex-col gap-3">
                <button onclick="resetData()" class="w-full p-2 bg-red-900/20 text-red-500 border border-red-900/50 rounded text-xs">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                <button onclick="toggleAdmin()" class="w-full p-2 bg-gray-800 rounded">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒç®—æ³•åƒæ•¸ ---
        const SEC_RATE = 0.000000001607; // æ¯ç§’åˆ©ç‡
        let state = {
            exRate: 31.37,
            curr: 'TWD',
            members: [
                { id: 0, name: "Lionel", baseUSD: 102.11, lastTS: Date.now(), history: [] },
                { id: 1, name: "Yosie", baseUSD: 92.1, lastTS: Date.now(), history: [] },
                { id: 2, name: "Yvonne", baseUSD: 92.1, lastTS: Date.now(), history: [] }
            ],
            logs: []
        };
        let undoStack = [];
        let chartObj = null;

        // --- åˆå§‹åŒ– ---
        function init() {
            const saved = localStorage.getItem('piggy_pro_v2');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // ç¢ºä¿æ­·å²ç´€éŒ„ä¸ç‚ºç©º
                state.members.forEach(m => { if(!m.history || m.history.length === 0) m.history = [{t: Date.now(), y: m.baseUSD}]; });
            }
            document.getElementById('exRateIn').value = state.exRate;
            document.getElementById('currBtn').innerText = state.curr;

            renderMembers();
            renderSelect();
            initChart();
            requestAnimationFrame(tick);
        }

        function save(isUndo = false) {
            if (!isUndo) {
                undoStack.push(JSON.stringify(state));
                if (undoStack.length > 30) undoStack.shift();
            }
            localStorage.setItem('piggy_pro_v2', JSON.stringify(state));
            updateLogUI();
        }

        // --- ç§’è¤‡åˆ©è¨ˆç®—å¼•æ“ ---
        function getNowUSD(member) {
            const elapsedSec = (Date.now() - member.lastTS) / 1000;
            return member.baseUSD * Math.pow(1 + SEC_RATE, elapsedSec);
        }

        function tick() {
            state.members.forEach(m => {
                const nowUSD = getNowUSD(m);
                const val = state.curr === 'USD' ? nowUSD : nowUSD * state.exRate;
                const el = document.getElementById(`amt-${m.id}`);
                if (el) el.innerText = val.toPrecision(12);
            });
            requestAnimationFrame(tick);
        }

        // --- äº¤æ˜“é‚è¼¯ ---
        function doTx(id, type) {
            const input = document.getElementById(`in-${id}`);
            const val = parseFloat(input.value);
            if (isNaN(val) || val <= 0) return;

            const m = state.members.find(x => x.id === id);
            const now = Date.now();
            const nowUSD = getNowUSD(m);
            const deltaUSD = state.curr === 'USD' ? val : val / state.exRate;

            // å¯«å…¥æ­·å²é» (ç”¨æ–¼åœ–è¡¨å‚ç›´è·³ç©º)
            m.history.push({ t: now, y: nowUSD }); // è®Šå‹•å‰çš„é»

            const nextUSD = type === 'in' ? nowUSD + deltaUSD : nowUSD - deltaUSD;
            m.baseUSD = Math.max(0, nextUSD);
            m.lastTS = now;

            m.history.push({ t: now, y: m.baseUSD }); // è®Šå‹•å¾Œçš„é»

            state.logs.unshift({
                n: m.name,
                type: type === 'in' ? 'å­˜å…¥' : 'æ”¯å‡º',
                v: val,
                c: state.curr,
                ts: new Date().toLocaleTimeString('zh-TW', {hour12:false})
            });
            if (state.logs.length > 10) state.logs.pop();

            input.value = '';
            save();
            updateChart();
        }

        // --- UI æ¸²æŸ“ ---
        function renderMembers() {
            const wrap = document.getElementById('membersContainer');
            wrap.innerHTML = state.members.map(m => `
                <div class="card p-4">
                    <div class="flex justify-between items-center mb-1">
                        <input type="text" value="${m.name}" onchange="updateName(${m.id}, this.value)"
                               class="bg-transparent border-none text-lg font-bold w-1/2 p-0 focus:ring-0">
                        <span class="text-[9px] text-gray-600 mono">SEC-Compounding</span>
                    </div>
                    <div class="text-2xl font-bold mono text-yellow-500 mb-4 h-8 flex items-center" id="amt-${m.id}">0.000000000000</div>
                    <div class="flex space-x-2">
                        <input type="number" id="in-${m.id}" inputmode="decimal" placeholder="é‡‘é¡"
                               class="flex-1 px-3 py-2 rounded text-base">
                        <button onclick="doTx(${m.id}, 'in')" class="btn-green px-5 py-2 rounded font-bold active:opacity-80">å­˜å…¥</button>
                        <button onclick="doTx(${m.id}, 'out')" class="btn-red px-5 py-2 rounded font-bold active:opacity-80">æ”¯å‡º</button>
                    </div>
                </div>
            `).join('');
            updateLogUI();
        }

        function updateLogUI() {
            const logBox = document.getElementById('logContainer');
            logBox.innerHTML = state.logs.map(l => `
                <div class="flex justify-between items-center bg-gray-800/20 p-2 rounded border border-gray-800/50 text-[11px]">
                    <span class="text-gray-400">${l.ts} <b class="text-gray-200 ml-1">${l.n}</b></span>
                    <span class="${l.type==='å­˜å…¥'?'text-green-500':'text-red-500'} font-bold">
                        ${l.type} ${l.v.toPrecision(12)} ${l.c}
                    </span>
                </div>
            `).join('');
        }

        // --- åœ–è¡¨é‚è¼¯ (å«æ™ºæ…§æ©«è»¸) ---
        function initChart() {
            const ctx = document.getElementById('assetChart').getContext('2d');
            chartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Asset USD',
                        borderColor: '#3fb950',
                        borderWidth: 2,
                        data: [],
                        stepped: 'before', // âœ¨ å¼·åˆ¶å‚ç›´è·³ç©ºé—œéµ
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            grid: { color: '#21262d' },
                            ticks: {
                                color: '#8b949e',
                                font: { size: 9 },
                                maxRotation: 0,
                                callback: function(value) {
                                    const d = new Date(value);
                                    const range = this.chart.scales.x.max - this.chart.scales.x.min;

                                    // æ™ºæ…§æ ¼å¼åˆ¤æ–·
                                    if (range > 86400000) { // å¤§æ–¼ 24 å°æ™‚
                                        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                                    } else {
                                        return `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
                                    }
                                }
                            }
                        },
                        y: {
                            grid: { color: '#21262d' },
                            ticks: { color: '#8b949e', font: { size: 9, family: 'JetBrains Mono' } }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            updateChart();
        }

        function updateChart() {
            const sid = parseInt(document.getElementById('chartSelect').value) || 0;
            const m = state.members.find(x => x.id === sid);

            // æ§‹å»ºé¡¯ç¤ºé»
            const dataPoints = [...m.history, { t: Date.now(), y: getNowUSD(m) }];
            chartObj.data.datasets[0].data = dataPoints.map(p => ({ x: p.t, y: p.y }));
            chartObj.update('none');
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function toggleCurrency() {
            state.curr = state.curr === 'TWD' ? 'USD' : 'TWD';
            document.getElementById('currBtn').innerText = state.curr;
            save(true);
        }

        function updateExRate(v) {
            const r = parseFloat(v);
            if (r > 0) { state.exRate = r; save(true); }
        }

        function updateName(id, n) {
            state.members.find(x => x.id === id).name = n;
            save(true);
            renderSelect();
        }

        function handleUndo() {
            if (undoStack.length === 0) return;
            state = JSON.parse(undoStack.pop());
            save(true);
            renderMembers();
            updateChart();
        }

        function renderSelect() {
            const s = document.getElementById('chartSelect');
            s.innerHTML = state.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        function toggleAdmin() {
            const m = document.getElementById('adminModal');
            if (m.classList.contains('hidden')) {
                document.getElementById('adminFields').innerHTML = state.members.map(x => `
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-500 mb-1">${x.name} åŸºæº–å€¼ (USD)</label>
                        <input type="number" step="0.01" value="${x.baseUSD}" onchange="adjBase(${x.id}, this.value)" class="p-2 rounded text-sm mono">
                    </div>
                `).join('');
                m.classList.remove('hidden');
            } else { m.classList.add('hidden'); }
        }

        function adjBase(id, v) {
            const m = state.members.find(x => x.id === id);
            m.baseUSD = parseFloat(v) || 0;
            m.lastTS = Date.now();
            m.history = [{ t: Date.now(), y: m.baseUSD }];
            save();
            updateChart();
        }

        function resetData() {
            if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) { localStorage.removeItem('piggy_pro_v2'); location.reload(); }
        }

        window.onload = init;
    </script>
</body>
</html>
