<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è±¬æ’²æ»¿ - å®¶åº­è™›æ“¬å¸³æœ¬</title>
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --bg: #f7f9fc;
            --card: #ffffff;
            --text: #2d3436;
            --gray: #95a5a6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-user-select: none; /* é˜²æ­¢æ‰‹æ©Ÿé•·æŒ‰é¸å–æ–‡å­— */
        }

        /* é ‚éƒ¨æ§åˆ¶å€ */
        .header {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ex-rate-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 1rem;
        }

        /* å¹£åˆ¥åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .currency-toggle {
            background: #eee;
            padding: 4px;
            border-radius: 10px;
            display: flex;
        }
        .currency-toggle label {
            padding: 6px 15px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.2s;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }

        /* æ­·å²èˆ‡å¾Œå°æŒ‰éˆ• */
        .tool-bar {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn-small {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }
        .btn-undo { background: var(--gray); }
        .btn-admin { background: #636e72; }

        /* å…’ç«¥å¡ç‰‡æ¨£å¼ */
        .card {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            box-sizing: border-box;
            border-left: 10px solid var(--primary);
            transition: transform 0.2s;
        }

        .name-input {
            font-size: 1.3rem;
            font-weight: 800;
            border: none;
            background: transparent;
            color: var(--text);
            width: 100%;
            margin-bottom: 5px;
            outline: none;
        }

        .balance-display {
            font-size: 1.8rem;
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
            letter-spacing: -1px;
            word-break: break-all;
        }

        .deposit-zone {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .deposit-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .deposit-input:focus { border-color: var(--secondary); }

        .btn-deposit {
            padding: 0 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
        }

        /* å¾Œå°é®ç½©å±¤ */
        #backend-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            color: white;
            z-index: 1000;
            padding: 25px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .backend-item {
            background: #333;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        .backend-item label { display: block; margin-bottom: 8px; color: #888; }
        .backend-item input {
            width: 100%;
            background: #111;
            color: #00ff00;
            border: 1px solid #444;
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 8px;
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="settings-row">
        <span>åŒ¯ç‡ 1 USD =</span>
        <input type="number" id="exRate" class="ex-rate-input" value="31.42" step="0.01" onchange="saveData()">
        <span>TWD</span>
    </div>
    <div class="settings-row">
        <span>é¡¯ç¤ºå¹£åˆ¥:</span>
        <div class="currency-toggle">
            <input type="radio" name="curr" id="currUSD" value="USD" onchange="setCurrency('USD')">
            <label for="currUSD">USD</label>
            <input type="radio" name="curr" id="currTWD" value="TWD" onchange="setCurrency('TWD')">
            <label for="currTWD">TWD</label>
        </div>
    </div>
    <div class="tool-bar">
        <button class="btn-small btn-undo" onclick="undo()">â†© å¾©åŸ</button>
        <button class="btn-small btn-undo" onclick="redo()">â†ª é‡åš</button>
        <button class="btn-small btn-admin" onclick="openBackend()">âš™ï¸ å¾Œå°ä¿®æ”¹</button>
    </div>
</div>

<div id="kids-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
    </div>

<div id="backend-overlay">
    <h2 style="margin-top: 0;">ğŸ›  å¾Œå°æ•¸æ“šèª¿æ•´</h2>
    <p style="color: #ff7675; font-size: 0.9rem;">ä¿®æ”¹å¾Œå°‡ç›´æ¥æ›´æ–°ç¾é‡‘åŸºæº–æœ¬é‡‘ä¸¦é‡æ–°è¨ˆæ™‚ã€‚</p>
    <div id="backend-list"></div>
    <button onclick="saveBackend()" class="btn-full" style="background: var(--primary); color: white;">ç¢ºèªå„²å­˜</button>
    <button onclick="closeBackend()" class="btn-full" style="background: transparent; border: 1px solid #555; color: #aaa;">å–æ¶ˆè¿”å›</button>
</div>

<script>
    const INTEREST_RATE_PER_SEC = 0.000000001607; // 0.0000001607% è½‰ç‚ºç´”å°æ•¸
    
    // é è¨­è³‡æ–™
    let state = {
        preferredCurrency: "USD",
        exRate: 31.42,
        kids: [
            { id: 0, name: "å°æœ‹å‹A", baseBalance: 100, lastTimestamp: Date.now() },
            { id: 1, name: "å°æœ‹å‹B", baseBalance: 89.99, lastTimestamp: Date.now() },
            { id: 2, name: "å°æœ‹å‹C", baseBalance: 89.99, lastTimestamp: Date.now() }
        ]
    };

    let historyStack = [];
    let redoStack = [];

    // åˆå§‹åŒ–
    function init() {
        const saved = localStorage.getItem('piggy_bank_v2');
        if (saved) {
            state = JSON.parse(saved);
        }
        
        // è¨­å®šåŒ¯ç‡èˆ‡å¹£åˆ¥ UI
        document.getElementById('exRate').value = state.exRate || 31.42;
        if (state.preferredCurrency === "TWD") {
            document.getElementById('currTWD').checked = true;
        } else {
            document.getElementById('currUSD').checked = true;
        }

        renderCards();
        tick();
    }

    function saveData() {
        state.exRate = parseFloat(document.getElementById('exRate').value);
        localStorage.setItem('piggy_bank_v2', JSON.stringify(state));
    }

    function pushHistory() {
        historyStack.push(JSON.stringify(state));
        if (historyStack.length > 30) historyStack.shift();
        redoStack = []; // åŸ·è¡Œæ–°å‹•ä½œæ™‚æ¸…ç©ºé‡åšå †ç–Š
    }

    // è¨ˆç®—ç›®å‰çš„å³æ™‚ç¸½é¡ (åˆ©æ¯è¨ˆç®—å…¬å¼)
    function calculateCurrentBalance(kid) {
        const now = Date.now();
        const secondsElapsed = (now - kid.lastTimestamp) / 1000;
        return kid.baseBalance * Math.pow(1 + INTEREST_RATE_PER_SEC, secondsElapsed);
    }

    // å¹£åˆ¥åˆ‡æ›æ§åˆ¶
    function setCurrency(val) {
        state.preferredCurrency = val;
        saveData();
        updateUI();
    }

    // å­˜å…¥åŠŸèƒ½
    function deposit(id) {
        const input = document.getElementById(`input-${id}`);
        const amount = parseFloat(input.value);
        if (isNaN(amount) || amount <= 0) return;

        pushHistory(); // ç´€éŒ„èˆŠç‹€æ…‹

        const kid = state.kids.find(k => k.id === id);
        const currentUsd = calculateCurrentBalance(kid);
        
        const isTWD = state.preferredCurrency === "TWD";
        const exRate = parseFloat(document.getElementById('exRate').value);
        const usdToAdd = isTWD ? amount / exRate : amount;

        // æ›´æ–°åŸºæº–é»
        kid.baseBalance = currentUsd + usdToAdd;
        kid.lastTimestamp = Date.now();

        input.value = '';
        saveData();
    }

    // ç”Ÿæˆå¡ç‰‡
    function renderCards() {
        const container = document.getElementById('kids-container');
        container.innerHTML = state.kids.map(kid => `
            <div class="card">
                <input type="text" class="name-input" value="${kid.name}" onchange="updateKidName(${kid.id}, this.value)">
                <div class="balance-display" id="balance-${kid.id}">0.00</div>
                <div class="deposit-zone">
                    <input type="number" class="deposit-input" id="input-${kid.id}" 
                           placeholder="å­˜å…¥é‡‘é¡" inputmode="decimal">
                    <button class="btn-deposit" onclick="deposit(${kid.id})">å­˜å…¥</button>
                </div>
            </div>
        `).join('');
    }

    function updateKidName(id, newName) {
        state.kids.find(k => k.id === id).name = newName;
        saveData();
    }

    // UI æ¯ç§’æ›´æ–°
    function updateUI() {
        const isTWD = state.preferredCurrency === "TWD";
        const exRate = parseFloat(document.getElementById('exRate').value);
        const symbol = isTWD ? "NT$" : "$";
        const decimals = isTWD ? 5 : 6; // é€™è£¡ä¿®æ”¹å°å¹£é¡¯ç¤º 5 ä½æ•¸

        state.kids.forEach(kid => {
            let balance = calculateCurrentBalance(kid);
            if (isTWD) balance *= exRate;
            
            const el = document.getElementById(`balance-${kid.id}`);
            if (el) el.innerText = `${symbol} ${balance.toFixed(decimals)}`;
        });
    }

    function tick() {
        updateUI();
        requestAnimationFrame(tick);
    }

    // å¾Œå°ç®¡ç†
    function openBackend() {
        const list = document.getElementById('backend-list');
        list.innerHTML = state.kids.map(kid => `
            <div class="backend-item">
                <label>${kid.name} çš„ç¾é‡‘é¤˜é¡ (USD)</label>
                <input type="number" id="back-input-${kid.id}" step="0.000001" value="${calculateCurrentBalance(kid).toFixed(6)}">
            </div>
        `).join('');
        document.getElementById('backend-overlay').style.display = 'block';
    }

    function saveBackend() {
        pushHistory();
        state.kids.forEach(kid => {
            const newVal = parseFloat(document.getElementById(`back-input-${kid.id}`).value);
            if (!isNaN(newVal)) {
                kid.baseBalance = newVal;
                kid.lastTimestamp = Date.now();
            }
        });
        saveData();
        closeBackend();
    }

    function closeBackend() {
        document.getElementById('backend-overlay').style.display = 'none';
    }

    // å¾©åŸèˆ‡é‡åš
    function undo() {
        if (historyStack.length > 0) {
            redoStack.push(JSON.stringify(state));
            state = JSON.parse(historyStack.pop());
            saveData();
            renderCards();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            historyStack.push(JSON.stringify(state));
            state = JSON.parse(redoStack.pop());
            saveData();
            renderCards();
        }
    }

    // å•Ÿå‹•ç¨‹å¼
    init();
</script>

</body>
</html>
