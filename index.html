const INTEREST_RATE_PER_SEC = 0.000000001607;
let state = {
    preferredCurrency: "USD", // 新增預設幣別欄位
    kids: [
        { id: 0, name: "小朋友A", baseBalance: 100, lastTimestamp: Date.now() },
        { id: 1, name: "小朋友B", baseBalance: 89.99, lastTimestamp: Date.now() },
        { id: 2, name: "小朋友C", baseBalance: 89.99, lastTimestamp: Date.now() }
    ]
};

let history = [];
let redoStack = [];

function init() {
    const saved = localStorage.getItem('piggy_bank_state');
    if (saved) {
        state = JSON.parse(saved);
        // 恢復上次選用的幣別
        if (state.preferredCurrency === "TWD") {
            document.getElementById('currTWD').checked = true;
        } else {
            document.getElementById('currUSD').checked = true;
        }
    }
    renderCards();
    tick();
}

function saveData() {
    localStorage.setItem('piggy_bank_state', JSON.stringify(state));
}

// 切換幣別並儲存選擇
function setCurrency(val) {
    state.preferredCurrency = val;
    saveData();
    updateUI();
}

function calculateCurrentBalance(kid) {
    const now = Date.now();
    const secondsElapsed = (now - kid.lastTimestamp) / 1000;
    return kid.baseBalance * Math.pow(1 + INTEREST_RATE_PER_SEC, secondsElapsed);
}

function deposit(id) {
    const input = document.getElementById(`input-${id}`);
    const amount = parseFloat(input.value);
    if (isNaN(amount) || amount <= 0) return;

    pushHistory();
    const kid = state.kids.find(k => k.id === id);
    const currentBalance = calculateCurrentBalance(kid);
    
    const isTWD = document.getElementById('currTWD').checked;
    const exRate = parseFloat(document.getElementById('exRate').value);
    const usdToDeposit = isTWD ? amount / exRate : amount;

    kid.baseBalance = currentBalance + usdToDeposit;
    kid.lastTimestamp = Date.now();

    input.value = '';
    saveData();
}

function updateUI() {
    const isTWD = document.getElementById('currTWD').checked;
    const exRate = parseFloat(document.getElementById('exRate').value);
    const symbol = isTWD ? "NT$" : "$";

    state.kids.forEach(kid => {
        let balance = calculateCurrentBalance(kid);
        if (isTWD) balance *= exRate;
        // 台幣顯示 5 位，美金顯示 6 位
        const decimals = isTWD ? 5 : 6;
        document.getElementById(`balance-${kid.id}`).innerText = `${symbol} ${balance.toFixed(decimals)}`;
    });
}

// ... (其餘 renderCards, openBackend, saveBackend, tick, undo, redo 函數保持不變) ...
