<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è±¬æ’²æ»¿ - å®¶åº­å¸³æœ¬</title>
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --bg: #f7f9fc; --card: #ffffff; --text: #2d3436; --gray: #95a5a6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .header, .card, .log-section { width: 100%; max-width: 500px; background: var(--card); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; padding: 15px; box-sizing: border-box; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ex-rate-input { width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        .currency-toggle { background: #eee; padding: 4px; border-radius: 10px; display: flex; }
        .currency-toggle label { padding: 6px 12px; cursor: pointer; border-radius: 8px; font-size: 0.85rem; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + label { background: var(--primary); color: white; }
        .tool-bar { display: flex; gap: 8px; margin-top: 10px; }
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; color: white; }
        .btn-small { flex: 1; padding: 8px; font-size: 0.8rem; }
        .btn-undo { background: var(--gray); }
        .btn-admin { background: #636e72; }
        .card { border-left: 10px solid var(--primary); }
        .name-input { font-size: 1.2rem; font-weight: 800; border: none; background: transparent; width: 100%; outline: none; }
        .balance-display { font-size: 1.7rem; font-family: monospace; font-weight: bold; color: var(--primary); margin: 8px 0; }
        .deposit-zone { display: flex; gap: 8px; }
        .deposit-input { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; outline: none; width: 40%; }
        .btn-deposit { padding: 0 12px; height: 45px; font-size: 0.9rem; flex-shrink: 0; }
        .log-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; color: var(--gray); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .log-item { font-size: 0.75rem; border-bottom: 1px solid #f8f8f8; padding: 8px 0; }
        .log-time { color: #b2bec3; font-family: monospace; }
        #backend-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; padding: 25px; box-sizing: border-box; overflow-y: auto; color: white; }
        .backend-item { background: #333; padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .backend-item input { width: 100%; background: #111; color: #00ff00; border: 1px solid #444; padding: 8px; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="header">
    <div class="settings-row">
        <span>åŒ¯ç‡ 1 USD = <input type="number" id="exRate" class="ex-rate-input" value="31.42" onchange="saveData()"> TWD</span>
    </div>
    <div class="settings-row">
        <span>å¹£åˆ¥:</span>
        <div class="currency-toggle">
            <input type="radio" name="curr" id="currUSD" value="USD" onchange="setCurrency('USD')"><label for="currUSD">USD</label>
            <input type="radio" name="curr" id="currTWD" value="TWD" onchange="setCurrency('TWD')"><label for="currTWD">TWD</label>
        </div>
    </div>
    <div class="tool-bar">
        <button class="btn-small btn-undo" onclick="undo()">â†© å¾©åŸ</button>
        <button class="btn-small btn-undo" onclick="redo()">â†ª é‡åš</button>
        <button class="btn-small btn-admin" onclick="openBackend()">âš™ï¸ å¾Œå°ä¿®æ”¹</button>
    </div>
</div>

<div id="kids-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>

<div class="log-section">
    <div class="log-title">ğŸ•’ æœ€è¿‘ç´€éŒ„</div>
    <div id="log-list"></div>
</div>

<div id="backend-overlay">
    <h2>ğŸ›  å¾Œå°ä¿®æ”¹</h2>
    <div id="backend-list"></div>
    <button onclick="saveBackend()" style="width:100%; padding:15px; background:var(--primary); border-radius:10px;">å„²å­˜</button>
    <button onclick="closeBackend()" style="width:100%; margin-top:10px; padding:10px; background:none; border:1px solid #555;">å–æ¶ˆ</button>
</div>

<script>
    const INTEREST_RATE_PER_SEC = 0.000000001607;
    let state = { preferredCurrency: "USD", exRate: 31.42, kids: [
        { id: 0, name: "Lionel", baseBalance: 100, lastTimestamp: Date.now() },
        { id: 1, name: "Yosie", baseBalance: 89.99, lastTimestamp: Date.now() },
        { id: 2, name: "å°æœ‹å‹C", baseBalance: 89.99, lastTimestamp: Date.now() }
    ], logs: [] };

    let historyStack = [], redoStack = [];

    function init() {
        const saved = localStorage.getItem('piggy_bank_final');
        if (saved) state = JSON.parse(saved);
        document.getElementById('exRate').value = state.exRate;
        if (state.preferredCurrency === "TWD") document.getElementById('currTWD').checked = true;
        else document.getElementById('currUSD').checked = true;
        renderCards(); renderLogs(); tick();
    }

    function saveData() {
        state.exRate = parseFloat(document.getElementById('exRate').value) || 31.42;
        localStorage.setItem('piggy_bank_final', JSON.stringify(state));
    }

    function addLog(name, oldVal, newVal) {
        const time = new Date().toLocaleString('zh-TW', { hour12: false });
        state.logs.unshift({ time, name, oldVal, newVal });
        if (state.logs.length > 10) state.logs.pop();
        renderLogs();
    }

    function renderLogs() {
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        const sym = isTWD ? "NT$" : "$";
        const dec = isTWD ? 5 : 6;
        document.getElementById('log-list').innerHTML = state.logs.map(log => `
            <div class="log-item">
                <span class="log-time">[${log.time.split(' ')[1]}]</span> <b>${log.name}</b><br>
                ${sym}${(log.oldVal * (isTWD ? rate : 1)).toFixed(dec)} âœ ${sym}${(log.newVal * (isTWD ? rate : 1)).toFixed(dec)}
            </div>
        `).join('');
    }

    function calculateCurrentBalance(kid) {
        return kid.baseBalance * Math.pow(1 + INTEREST_RATE_PER_SEC, (Date.now() - kid.lastTimestamp) / 1000);
    }

    function setCurrency(val) { state.preferredCurrency = val; saveData(); renderLogs(); }

    function deposit(id, isExpense) {
        const input = document.getElementById(`input-${id}`);
        let amount = parseFloat(input.value);
        if (isNaN(amount) || amount === 0) return;
        if (isExpense) amount = -Math.abs(amount);

        pushHistory();
        const kid = state.kids.find(k => k.id === id);
        const oldUsd = calculateCurrentBalance(kid);
        const usdToAdd = (state.preferredCurrency === "TWD") ? amount / state.exRate : amount;

        kid.baseBalance = oldUsd + usdToAdd;
        kid.lastTimestamp = Date.now();
        addLog(kid.name, oldUsd, kid.baseBalance);
        input.value = ''; saveData();
    }

    function renderCards() {
        document.getElementById('kids-container').innerHTML = state.kids.map(kid => `
            <div class="card">
                <input type="text" class="name-input" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                <div class="balance-display" id="balance-${kid.id}">0.00</div>
                <div class="deposit-zone">
                    <input type="number" class="deposit-input" id="input-${kid.id}" placeholder="é‡‘é¡" inputmode="decimal">
                    <button class="btn-deposit" style="background:var(--secondary);" onclick="deposit(${kid.id}, false)">å­˜å…¥</button>
                    <button class="btn-deposit" style="background:#ff7675;" onclick="deposit(${kid.id}, true)">æ”¯å‡º</button>
                </div>
            </div>
        `).join('');
    }

    function updateName(id, name) { state.kids.find(k => k.id === id).name = name; saveData(); }

    function openBackend() {
        document.getElementById('backend-list').innerHTML = state.kids.map(kid => `
            <div class="backend-item">
                <label>${kid.name} (USDåŸºæº–)</label>
                <input type="number" id="back-${kid.id}" step="0.000001" value="${calculateCurrentBalance(kid).toFixed(6)}">
            </div>
        `).join('');
        document.getElementById('backend-overlay').style.display = 'block';
    }

    function saveBackend() {
        pushHistory();
        state.kids.forEach(kid => {
            const oldUsd = calculateCurrentBalance(kid);
            const newVal = parseFloat(document.getElementById(`back-${kid.id}`).value);
            if (!isNaN(newVal) && Math.abs(oldUsd - newVal) > 0.000001) {
                kid.baseBalance = newVal;
                kid.lastTimestamp = Date.now();
                addLog(kid.name, oldUsd, newVal);
            }
        });
        saveData(); closeBackend();
    }

    function closeBackend() { document.getElementById('backend-overlay').style.display = 'none'; }
    function pushHistory() { historyStack.push(JSON.stringify(state)); redoStack = []; if (historyStack.length > 30) historyStack.shift(); }

    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(state)); state = JSON.parse(historyStack.pop()); saveData(); renderCards(); renderLogs(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(state)); state = JSON.parse(redoStack.pop()); saveData(); renderCards(); renderLogs(); } }

    function tick() {
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        state.kids.forEach(kid => {
            let bal = calculateCurrentBalance(kid) * (isTWD ? rate : 1);
            const el = document.getElementById(`balance-${kid.id}`);
            if (el) el.innerText = `${isTWD ? 'NT$' : '$'} ${bal.toFixed(isTWD ? 5 : 6)}`;
        });
        requestAnimationFrame(tick);
    }
    init();
</script>
</body>
</html>
