<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è±¬æ’²æ»¿ - æ™ºæ…§è¶¨å‹¢ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --bg: #f7f9fc; --card: #ffffff; --text: #2d3436; --gray: #95a5a6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }

        .header, .card, .log-section { width: 100%; max-width: 500px; background: var(--card); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; padding: 15px; box-sizing: border-box; }

        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ex-rate-input { width: 75px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        .currency-toggle { background: #eee; padding: 4px; border-radius: 10px; display: flex; }
        .currency-toggle label { padding: 6px 12px; cursor: pointer; border-radius: 8px; font-size: 0.85rem; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + label { background: var(--primary); color: white; }

        .tool-bar { display: flex; gap: 8px; margin-top: 10px; }
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; color: white; }
        .btn-small { flex: 1; padding: 10px; font-size: 0.8rem; }
        .btn-undo { background: var(--gray); }
        .btn-admin { background: #636e72; }

        .card { border-left: 10px solid var(--primary); }
        .name-row { display: flex; justify-content: space-between; align-items: center; }
        .name-input { font-size: 1.2rem; font-weight: 800; border: none; background: transparent; width: 60%; outline: none; }
        .btn-detail { background: #74b9ff; font-size: 0.75rem; padding: 5px 10px; }

        .balance-display { font-size: 1.4rem; font-family: monospace; font-weight: bold; color: var(--primary); margin: 10px 0; word-break: break-all; }
        .deposit-zone { display: flex; gap: 8px; }
        .deposit-input { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; outline: none; width: 35%; font-size: 1rem; }
        .btn-deposit { padding: 0 15px; height: 45px; font-size: 0.9rem; flex-shrink: 0; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; color: white; }
        .overlay h2 { margin: 0 0 15px 0; font-size: 1.2rem; text-align: center; }

        .chart-container { background: #1e1e1e; border-radius: 15px; padding: 10px; margin-bottom: 20px; height: 320px; position: relative; }

        .detail-info { background: #1e1e1e; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .detail-label { color: #888; font-size: 0.8rem; margin-bottom: 4px; }
        .detail-value { font-family: monospace; font-size: 1.1rem; color: #fff; margin-bottom: 12px; word-break: break-all; }
        .interest-value { color: #00ecbc; font-weight: bold; }

        .log-section { font-size: 0.8rem; }
        .log-item { border-bottom: 1px solid #f1f3f5; padding: 8px 0; }
        .tag { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.7rem; margin-right: 4px; display: inline-block; }
        .tag-deposit { background: var(--secondary); }
        .tag-expense { background: var(--primary); }
    </style>
</head>
<body>

<div class="header">
    <div class="settings-row">
        <span>åŒ¯ç‡ 1 USD = <input type="number" id="exRate" class="ex-rate-input" value="31.42" onchange="saveData()"> TWD</span>
    </div>
    <div class="settings-row">
        <span>é¡¯ç¤ºå¹£åˆ¥:</span>
        <div class="currency-toggle">
            <input type="radio" name="curr" id="currUSD" value="USD" onchange="setCurrency('USD')"><label for="currUSD">USD</label>
            <input type="radio" name="curr" id="currTWD" value="TWD" onchange="setCurrency('TWD')"><label for="currTWD">TWD</label>
        </div>
    </div>
    <div class="tool-bar">
        <button class="btn-small btn-undo" onclick="undo()">â†© å¾©åŸ</button>
        <button class="btn-small btn-undo" onclick="redo()">â†ª é‡åš</button>
        <button class="btn-small btn-admin" onclick="openBackend()">âš™ï¸ å¾Œå°ç®¡ç†</button>
    </div>
</div>

<div id="kids-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>

<div class="log-section">
    <div style="font-weight:bold; color:var(--gray); margin-bottom:10px;">ğŸ•’ æœ€è¿‘è®Šå‹•ç´€éŒ„</div>
    <div id="log-list"></div>
</div>

<div id="detail-overlay" class="overlay">
    <h2 id="detail-title">è³‡ç”¢è¶¨å‹¢</h2>

    <div class="chart-container">
        <canvas id="historyChart"></canvas>
    </div>

    <div class="detail-info">
        <div class="detail-label">åŸºæº–æœ¬é‡‘ (Settlement)</div>
        <div id="detail-base" class="detail-value"></div>
        <div class="detail-label">ç´¯è¨ˆåˆ©æ¯ (Accrued)</div>
        <div id="detail-interest" class="detail-value interest-value"></div>
    </div>

    <button onclick="closeDetail()" style="width:100%; padding:15px; background:var(--secondary); border-radius:12px;">é—œé–‰é¢æ¿</button>
</div>

<div id="backend-overlay" class="overlay" style="background: rgba(0,0,0,0.95);">
    <h2>âš™ï¸ å¾Œå°æ ¡æ­£</h2>
    <div id="backend-list"></div>
    <button onclick="saveBackend()" style="width:100%; padding:15px; background:var(--primary); border-radius:12px; margin-top:15px;">å„²å­˜</button>
    <button onclick="closeBackend()" style="width:100%; margin-top:10px; background:none; border:1px solid #555;">å–æ¶ˆ</button>
</div>

<script>
    const INTEREST_RATE_PER_SEC = 0.000000001607;
    let state = {
        preferredCurrency: "USD",
        exRate: 31.42,
        kids: [
            { id: 0, name: "Lionel", baseBalance: 100, lastTimestamp: Date.now(), history: [] },
            { id: 1, name: "Yosie", baseBalance: 89.99, lastTimestamp: Date.now(), history: [] },
            { id: 2, name: "Yv", baseBalance: 89.99, lastTimestamp: Date.now(), history: [] }
        ],
        logs: []
    };

    let historyStack = [], redoStack = [], currentDetailId = null, myChart = null;

    function init() {
        const saved = localStorage.getItem('piggy_bank_v7_smart');
        if (saved) state = JSON.parse(saved);

        state.kids.forEach(k => {
            if(!k.history || k.history.length === 0) {
                k.history = [{ t: k.lastTimestamp, y: k.baseBalance }];
            }
        });

        document.getElementById('exRate').value = state.exRate || 31.42;
        if (state.preferredCurrency === "TWD") document.getElementById('currTWD').checked = true;
        else document.getElementById('currUSD').checked = true;

        renderCards(); renderLogs(); tick();
    }

    function saveData() {
        state.exRate = parseFloat(document.getElementById('exRate').value) || 31.42;
        localStorage.setItem('piggy_bank_v7_smart', JSON.stringify(state));
    }

    function format12(num) { return Number(num).toPrecision(12); }

    function calculateCurrentBalance(kid) {
        return kid.baseBalance * Math.pow(1 + INTEREST_RATE_PER_SEC, (Date.now() - kid.lastTimestamp) / 1000);
    }

    function recordHistory(kid) {
        kid.history.push({ t: Date.now(), y: kid.baseBalance });
        // æå‡ç´€éŒ„å®¹é‡è‡³ 1000 é»ï¼Œç¢ºä¿é•·æœŸæ›²ç·šå“è³ª
        if (kid.history.length > 1000) kid.history.shift();
    }

    function deposit(id, isExpense) {
        const input = document.getElementById(`input-${id}`);
        let amount = parseFloat(input.value);
        if (isNaN(amount) || amount === 0) return;

        pushHistory();
        const kid = state.kids.find(k => k.id === id);
        const oldUsd = calculateCurrentBalance(kid);
        const usdToAdd = (state.preferredCurrency === "TWD") ? amount / state.exRate : amount;

        kid.baseBalance = oldUsd + (isExpense ? -Math.abs(usdToAdd) : Math.abs(usdToAdd));
        kid.lastTimestamp = Date.now();

        recordHistory(kid);
        state.logs.unshift({ time: new Date().toLocaleString(), action: isExpense?"æ”¯å‡º":"å­˜å…¥", name: kid.name, oldVal: oldUsd, newVal: kid.baseBalance });
        if (state.logs.length > 10) state.logs.pop();

        input.value = ''; saveData(); renderLogs();
    }

    function openDetail(id) {
        currentDetailId = id;
        const kid = state.kids.find(k => k.id === id);
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;

        document.getElementById('detail-title').innerText = kid.name + " çš„è³‡ç”¢è¶¨å‹¢";
        document.getElementById('detail-overlay').style.display = 'block';

        const ctx = document.getElementById('historyChart').getContext('2d');
        const currentPoints = [...kid.history, { t: Date.now(), y: calculateCurrentBalance(kid) }];
        const chartData = currentPoints.map(pt => ({ x: pt.t, y: pt.y * (isTWD ? rate : 1) }));

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'è³‡ç”¢ç¸½é¡',
                    data: chartData,
                    borderColor: '#00ecbc',
                    borderWidth: 2,
                    pointRadius: currentPoints.length < 50 ? 3 : 0, // é»å¤šæ™‚éš±è—åœ“é»ï¼Œç•«é¢æ›´ä¹¾æ·¨
                    fill: true,
                    backgroundColor: (context) => {
                        const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 300);
                        gradient.addColorStop(0, 'rgba(0, 236, 188, 0.4)');
                        gradient.addColorStop(1, 'rgba(0, 236, 188, 0)');
                        return gradient;
                    },
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        type: 'linear',
                        display: true,
                        grid: { color: '#222' },
                        ticks: {
                            color: '#777',
                            font: { size: 10 },
                            callback: function(value) {
                                const date = new Date(value);
                                const today = new Date();
                                // --- æ™ºæ…§æ¨™ç±¤é‚è¼¯ ---
                                // å¦‚æœæ¨™ç±¤æ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼Œé¡¯ç¤º æœˆ/æ—¥ æ™‚:åˆ†
                                if (date.toLocaleDateString() !== today.toLocaleDateString()) {
                                    return (date.getMonth() + 1) + '/' + date.getDate() + ' ' + date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0');
                                }
                                // å¦‚æœæ˜¯ä»Šå¤©ï¼Œå‰‡é¡¯ç¤º æ™‚:åˆ†:ç§’
                                return date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0') + ':' + String(date.getSeconds()).padStart(2, '0');
                            }
                        }
                    },
                    y: {
                        grid: { color: '#222' },
                        ticks: { color: '#888', font: { size: 10 } }
                    }
                }
            }
        });
    }

    function closeDetail() {
        currentDetailId = null;
        document.getElementById('detail-overlay').style.display = 'none';
    }

    function tick() {
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        const sym = isTWD ? "NT$" : "$";

        state.kids.forEach(kid => {
            const currentTotalUsd = calculateCurrentBalance(kid);
            const displayTotal = currentTotalUsd * (isTWD ? rate : 1);
            const el = document.getElementById(`balance-${kid.id}`);
            if (el) el.innerText = `${sym} ${format12(displayTotal)}`;

            if (currentDetailId === kid.id) {
                document.getElementById('detail-base').innerText = `${sym} ${format12(kid.baseBalance * (isTWD ? rate : 1))}`;
                document.getElementById('detail-interest').innerText = `+ ${sym} ${format12((currentTotalUsd - kid.baseBalance) * (isTWD ? rate : 1))}`;

                if(myChart) {
                    const newData = [...kid.history, { t: Date.now(), y: currentTotalUsd }];
                    myChart.data.datasets[0].data = newData.map(pt => ({ x: pt.t, y: pt.y * (isTWD ? rate : 1) }));
                    myChart.update('none');
                }
            }
        });
        requestAnimationFrame(tick);
    }

    function renderCards() {
        document.getElementById('kids-container').innerHTML = state.kids.map(kid => `
            <div class="card">
                <div class="name-row">
                    <input type="text" class="name-input" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                    <button class="btn-detail" onclick="openDetail(${kid.id})">ç´°ç¯€åœ–è¡¨</button>
                </div>
                <div class="balance-display" id="balance-${kid.id}">0.00</div>
                <div class="deposit-zone">
                    <input type="number" class="deposit-input" id="input-${kid.id}" placeholder="é‡‘é¡" inputmode="decimal">
                    <button class="btn-deposit" style="background:var(--secondary);" onclick="deposit(${kid.id}, false)">å­˜å…¥</button>
                    <button class="btn-deposit" style="background:var(--primary);" onclick="deposit(${kid.id}, true)">æ”¯å‡º</button>
                </div>
            </div>`).join('');
    }

    function updateName(id, name) { state.kids.find(k => k.id === id).name = name; saveData(); }
    function setCurrency(val) { state.preferredCurrency = val; saveData(); renderLogs(); }

    function openBackend() {
        document.getElementById('backend-list').innerHTML = state.kids.map(kid => `
            <div style="margin-bottom:10px;"><label style="color:#888;font-size:0.8rem;">${kid.name}</label>
            <input type="number" id="back-${kid.id}" style="width:100%;padding:10px;background:#111;color:#00ff00;border:1px solid #444;" step="0.000001" value="${calculateCurrentBalance(kid).toFixed(8)}"></div>`).join('');
        document.getElementById('backend-overlay').style.display = 'block';
    }
    function saveBackend() {
        pushHistory();
        state.kids.forEach(kid => {
            const oldUsd = calculateCurrentBalance(kid);
            const newVal = parseFloat(document.getElementById(`back-${kid.id}`).value);
            if (!isNaN(newVal) && Math.abs(oldUsd - newVal) > 0.0000001) {
                kid.baseBalance = newVal; kid.lastTimestamp = Date.now();
                recordHistory(kid);
                state.logs.unshift({ time: new Date().toLocaleString(), action: "æ ¡æ­£", name: kid.name, oldVal: oldUsd, newVal: kid.baseBalance });
            }
        });
        saveData(); document.getElementById('backend-overlay').style.display = 'none'; renderLogs();
    }

    function renderLogs() {
        const isTWD = state.preferredCurrency === "TWD";
        const rate = state.exRate;
        document.getElementById('log-list').innerHTML = state.logs.map(log => `
            <div class="log-item"><span class="tag ${log.action==='å­˜å…¥'?'tag-deposit':'tag-expense'}">${log.action}</span> <b>${log.name}</b><br>
            <span style="color:#999;font-size:0.7rem;">${log.time}</span><br>
            ${isTWD?'NT$':'$'}${format12(log.oldVal*(isTWD?rate:1))} âœ ${isTWD?'NT$':'$'}${format12(log.newVal*(isTWD?rate:1))}</div>`).join('');
    }

    function closeBackend() { document.getElementById('backend-overlay').style.display = 'none'; }
    function pushHistory() { historyStack.push(JSON.stringify(state)); redoStack = []; if (historyStack.length > 30) historyStack.shift(); }
    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(state)); state = JSON.parse(historyStack.pop()); saveData(); renderCards(); renderLogs(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(state)); state = JSON.parse(redoStack.pop()); saveData(); renderCards(); renderLogs(); } }

    init();
</script>
</body>
</html>
